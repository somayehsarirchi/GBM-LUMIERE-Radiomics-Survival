## scripts/03_plot_results.R
##
## This script generates all figures used in the R Markdown report:
## - Radiomics correlation heatmap
## - Kaplan–Meier survival curves
## - Time-dependent C-index curves
## - Bootstrapped C-index (.632)
## - Brier score (prediction error) curves
## - Bootstrapped Brier score (.632+)
## - Risk-stratified survival curves
##
## All plots are exported as PNG files to the results/ directory.

rm(list = ls())

# Load required packages
library(tidyverse)
library(readr)
library(survival)
library(survminer)
library(pheatmap)
library(corrplot)
library(riskRegression)
library(pec)
library(here)

# Ensure results directory exists
dir.create(here("results"), showWarnings = FALSE, recursive = TRUE)

# ---------------------------------------------------------
# 1) Load objects generated by 02_run_survival_models.R
# ---------------------------------------------------------

mydata     <- readRDS(here("results", "mydata_full_td.rds"))
eval_data  <- readRDS(here("results", "eval_data_complete_cases.rds"))
model_cc   <- readRDS(here("results", "model_cc_coxph.rds"))
eval_times <- readRDS(here("results", "eval_times_quartiles.rds"))
times_grid <- readRDS(here("results", "times_grid_cindex.rds"))
times_grid2<- readRDS(here("results", "times_grid_brier.rds"))

# Helper function to save ggplots
save_gg <- function(plot_obj, filename, width = 7, height = 5, dpi = 300) {
  ggsave(
    filename = here("results", filename),
    plot     = plot_obj,
    width    = width,
    height   = height,
    dpi      = dpi
  )
}

# ---------------------------------------------------------
# 2) Radiomics correlation heatmap
# ---------------------------------------------------------

num_df <- mydata %>% dplyr::select(where(is.numeric))
cm <- cor(num_df, use = "pairwise.complete.obs", method = "spearman")
d  <- as.dist(1 - abs(cm))

# ---------------------------
# Version 1 — Clean (no labels)
# ---------------------------

png(filename = here("results", "fig_radiomics_correlation_heatmap_clean.png"),
    width = 2000, height = 2000, res = 300)

pheatmap::pheatmap(
  cm,
  clustering_distance_rows = d,
  clustering_distance_cols = d,
  show_rownames = FALSE,
  show_colnames = FALSE,
  fontsize = 6,
  main = "Radiomics feature correlation (Spearman)"
)

dev.off()

# ---------------------------
# Version 2 — Annotated (with names)
# ---------------------------

png(filename = here("results", "fig_radiomics_correlation_heatmap_annotated.png"),
    width = 3000, height = 3000, res = 300)

pheatmap::pheatmap(
  cm,
  clustering_distance_rows = d,
  clustering_distance_cols = d,
  show_rownames = TRUE,
  show_colnames = TRUE,
  fontsize_row = 4,
  fontsize_col = 4,
  main = "Radiomics correlation heatmap (with feature names)"
)

dev.off()


# ---------------------------------------------------------
# 3) Kaplan–Meier overall survival
# ---------------------------------------------------------

fit_overall <- survfit(Surv(Survival, event) ~ 1, data = mydata)

km_overall <- ggsurvplot(
  fit_overall, data = mydata,
  conf.int = FALSE,
  xlab = "Time (weeks)",
  title = "Overall Kaplan–Meier survival curve"
)

save_gg(km_overall$plot, "fig_km_overall_survival.png")

# ---------------------------------------------------------
# 4) KM curves by RANO Rating3 (if available)
# ---------------------------------------------------------

if ("Rating3" %in% names(mydata)) {
  
  fit_rating3 <- survfit(Surv(Survival, event) ~ Rating3, data = mydata)
  
  km_rating3 <- ggsurvplot(
    fit_rating3, data = mydata,
    conf.int = TRUE,
    xlab = "Time (weeks)",
    title = "KM survival by RANO Rating3"
  )
  
  save_gg(km_rating3$plot, "fig_km_by_RANO_Rating3.png")
}

# ---------------------------------------------------------
# 5) Time-dependent C-index curve (apparent)
# ---------------------------------------------------------

c_td_curve <- cindex(
  object      = list("Cox_final" = model_cc),
  formula     = Surv(Survival, event) ~ 1,
  data        = eval_data,
  eval.times  = times_grid,
  cens.model  = "cox",
  splitMethod = "noPlan"
)

c_curve <- data.frame(
  time   = times_grid,
  Cindex = as.numeric(c_td_curve$AppCindex$Cox_final)
)

p_cindex_curve <- ggplot(c_curve, aes(x = time, y = Cindex)) +
  geom_line(linewidth = 1.1) +
  theme_bw(base_size = 13) +
  labs(
    title = "Time-dependent C-index curve",
    x = "Time (weeks)",
    y = "C-index(t)"
  )

save_gg(p_cindex_curve, "fig_cindex_curve_apparent.png")

# ---------------------------------------------------------
# 6) Brier score (prediction error curve) — apparent
# ---------------------------------------------------------

pec_obj <- pec(
  object      = list("Cox_final" = model_cc),
  formula     = Surv(Survival, event) ~ 1,
  data        = eval_data,
  times       = times_grid2,
  cens.model  = "cox",
  splitMethod = "noPlan"
)

brier_df <- data.frame(
  time_weeks = pec_obj$time,
  Brier      = as.numeric(pec_obj$AppErr$Cox_final)
)

p_brier <- ggplot(brier_df, aes(x = time_weeks, y = Brier)) +
  geom_line(linewidth = 1.1) +
  theme_bw(base_size = 13) +
  labs(
    title = "Prediction error curve (Brier score)",
    x = "Time (weeks)",
    y = "Brier(t)"
  )

save_gg(p_brier, "fig_brier_curve_apparent.png")

# Save Brier values at evaluation times
idx <- sapply(eval_times, function(t) which.min(abs(pec_obj$time - t)))
brier_selected <- brier_df[idx, ]
brier_selected$target_time <- eval_times

write_csv(brier_selected, here("results", "brier_three_times_apparent.csv"))

# Save IBS
ibs_res <- crps(
  object = pec_obj,
  models = "Cox_final",
  times  = eval_times
)
saveRDS(ibs_res, here("results", "ibs_apparent.rds"))

# ---------------------------------------------------------
# 7) Bootstrap .632 C-index
# ---------------------------------------------------------

set.seed(20231202)

cindex_boot <- cindex(
  object      = list("Cox_final" = model_cc),
  formula     = Surv(Survival, event) ~ 1,
  data        = eval_data,
  eval.times  = times_grid,
  cens.model  = "cox",
  splitMethod = "boot632",
  B           = 200
)

cindex_boot_df <- data.frame(
  time_weeks = times_grid,
  Cindex     = as.numeric(cindex_boot$AppCindex$Cox_final)
)

p_cindex_boot <- ggplot(cindex_boot_df, aes(x = time_weeks, y = Cindex)) +
  geom_line(linewidth = 1.1) +
  theme_bw(base_size = 13) +
  labs(
    title = "Bootstrap .632 time-dependent C-index",
    x = "Time (weeks)",
    y = "C-index(t)"
  )

save_gg(p_cindex_boot, "fig_cindex_curve_boot632.png")

# Export selected times
idx2 <- sapply(eval_times, function(t) which.min(abs(cindex_boot_df$time_weeks - t)))
cindex_boot_selected <- cindex_boot_df[idx2, ]
cindex_boot_selected$target_time <- eval_times
cindex_boot_selected$Cindex_pct  <- 100 * cindex_boot_selected$Cindex

write_csv(cindex_boot_selected, here("results", "cindex_boot_three_times.csv"))

# ---------------------------------------------------------
# 8) Bootstrap .632+ prediction error curves
# ---------------------------------------------------------

set.seed(20231202)

pec_boot <- pec(
  object      = list("Cox_final" = model_cc),
  formula     = Surv(Survival, event) ~ 1,
  data        = eval_data,
  times       = times_grid2,
  cens.model  = "cox",
  splitMethod = "Boot632plus",
  B           = 200,
  exact       = FALSE
)

brier_boot_df <- data.frame(
  time_weeks = pec_boot$time,
  Brier      = as.numeric(pec_boot$AppErr$Cox_final)
)

p_brier_boot <- ggplot(brier_boot_df, aes(x = time_weeks, y = Brier)) +
  geom_line(linewidth = 1.1) +
  theme_bw(base_size = 13) +
  labs(
    title = "Bootstrap .632+ prediction error curve",
    x = "Time (weeks)",
    y = "Brier(t)"
  )

save_gg(p_brier_boot, "fig_brier_curve_boot632plus.png")

# IBS (.632+)
ibs_boot <- crps(
  object = pec_boot,
  models = "Cox_final",
  times  = eval_times
)

saveRDS(ibs_boot, here("results", "ibs_boot632plus.rds"))

# ---------------------------------------------------------
# 9) Risk stratification based on Cox linear predictor
# ---------------------------------------------------------

eval_data$risk_score <- predict(model_cc, type = "lp")
eval_data$risk_group <- dplyr::ntile(eval_data$risk_score, 3)
eval_data$risk_group <- factor(eval_data$risk_group,
                               labels = c("Low", "Medium", "High"))

fit_risk <- survfit(Surv(Survival, event) ~ risk_group, data = eval_data)

km_risk <- ggsurvplot(
  fit_risk, data = eval_data,
  conf.int   = TRUE,
  pval       = TRUE,
  risk.table = TRUE,
  xlab       = "Time (weeks)",
  title      = "Survival by Cox-derived risk groups",
  legend.title = "Risk group"
)

# Save KM curve without risk table
save_gg(km_risk$plot, "fig_km_risk_groups.png")

# Save full KM plot (curve + risk table)
png(filename = here("results", "fig_km_risk_groups_with_table.png"),
    width = 2000, height = 2000, res = 300)
print(km_risk)
dev.off()

cat("All figures successfully saved in 'results/'.\n")
